name: CI - Tests, Lint & Coverage

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:  # Manual trigger

jobs:
  lint:
    name: ðŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint black isort mypy
        pip install -r requirements.txt || echo "âš ï¸ Some dependencies may require GPU"
    
    - name: ðŸŽ¨ Check code formatting with Black
      run: |
        black --check --diff src/ tests/ || echo "âš ï¸ Black formatting issues found"
      continue-on-error: true
    
    - name: ðŸ“ Check import sorting with isort
      run: |
        isort --check-only --diff src/ tests/ || echo "âš ï¸ Import sorting issues found"
      continue-on-error: true
    
    - name: ðŸ”Ž Lint with flake8
      run: |
        # Stop build if there are Python syntax errors or undefined names
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Warnings (non-blocking)
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
    
    - name: ðŸ”¬ Type checking with mypy
      run: |
        mypy src/ --ignore-missing-imports --no-strict-optional || echo "âš ï¸ Type checking issues found"
      continue-on-error: true

  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-mock pytest-asyncio
        pip install -r requirements.txt || echo "âš ï¸ Some dependencies may require GPU"
    
    - name: ðŸ§ª Run unit tests
      run: |
        pytest tests/ -v --tb=short --strict-markers || echo "âš ï¸ Some tests may fail without GPU"
      continue-on-error: true
    
    - name: ðŸ“Š Run tests with coverage
      run: |
        pytest tests/ --cov=src --cov-report=xml --cov-report=term-missing --cov-fail-under=50
      continue-on-error: true
    
    - name: ðŸ“¤ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      continue-on-error: true

  validate-quick-wins:
    name: âœ… Validate Quick Wins
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || echo "âš ï¸ Some dependencies may require GPU"
    
    - name: âœ… Validate Quick Wins 1 & 2
      run: |
        python validate_quick_wins.py || echo "âš ï¸ Validation requires full environment"
      continue-on-error: true
    
    - name: ðŸ“Š Benchmark Async Logging (Quick Win 3)
      run: |
        timeout 30s python benchmark_async_logging.py || echo "âš ï¸ Benchmark timeout or requires full environment"
      continue-on-error: true

  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ðŸ”’ Run Bandit security scan
      run: |
        pip install bandit[toml]
        bandit -r src/ -f json -o bandit-report.json || echo "âš ï¸ Security issues found"
      continue-on-error: true
    
    - name: ðŸ“¦ Check for vulnerable dependencies
      run: |
        pip install safety
        safety check --json || echo "âš ï¸ Vulnerable dependencies found"
      continue-on-error: true

  docker-build:
    name: ðŸ³ Docker Build Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ”¨ Build Docker image (test only)
      run: |
        echo "FROM python:3.10-slim" > Dockerfile.test
        echo "WORKDIR /app" >> Dockerfile.test
        echo "COPY requirements.txt ." >> Dockerfile.test
        echo "RUN pip install --no-cache-dir -r requirements.txt || true" >> Dockerfile.test
        echo "COPY . ." >> Dockerfile.test
        echo "CMD ['python', 'main.py']" >> Dockerfile.test
        docker build -f Dockerfile.test -t jarvis-ia-test . || echo "âš ï¸ Docker build may fail without GPU runtime"
      continue-on-error: true

  summary:
    name: ðŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, validate-quick-wins, security]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate summary
      run: |
        echo "## ðŸŽ¯ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Lint**: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Quick Wins Validation**: ${{ needs.validate-quick-wins.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security**: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Notes" >> $GITHUB_STEP_SUMMARY
        echo "- Some jobs may show warnings due to GPU-dependent packages" >> $GITHUB_STEP_SUMMARY
        echo "- Quick Wins validation requires full environment with models" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage target: â‰¥50%" >> $GITHUB_STEP_SUMMARY
